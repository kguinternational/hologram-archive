name: Layer 4 Manifold Performance Benchmarks

on:
  pull_request:
    paths:
      - 'layers/layer4-manifold/**'
      - '.github/workflows/layer4-benchmarks.yml'
    branches: [ main ]
  push:
    branches: [ main ]
    paths:
      - 'layers/layer4-manifold/**'
  workflow_dispatch:
    inputs:
      update_baseline:
        description: 'Update performance baseline on improvements'
        required: false
        default: 'false'
        type: boolean
      threshold:
        description: 'Performance degradation threshold (%)'
        required: false
        default: '10'
        type: string

# Allow one concurrent benchmark run per PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: 1

jobs:
  # Detect changes to determine if benchmarks should run
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.changes.outputs.layer4 }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            layer4:
              - 'layers/layer4-manifold/**'
              - '.github/workflows/layer4-benchmarks.yml'

  # Build dependencies (Layer 0-3)
  build-dependencies:
    needs: detect-changes
    if: needs.detect-changes.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        build_type: [debug, release]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Cache dependencies build
        uses: actions/cache@v3
        with:
          path: |
            lib/
            layers/*/build/
          key: ${{ runner.os }}-deps-${{ matrix.build_type }}-${{ hashFiles('layers/layer[0-3]*/src/**', 'layers/layer[0-3]*/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-deps-${{ matrix.build_type }}-
            ${{ runner.os }}-deps-
            
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang llvm-dev libc6-dev
          
      - name: Build Layer 0 (Atlas Core)
        run: |
          cd layers/layer0-atlas
          make BUILD_TYPE=${{ matrix.build_type == 'release' && 'RELEASE' || 'DEBUG' }}
          
      - name: Build Layer 1 (Boundary)
        run: |
          cd layers/layer1-boundary
          make BUILD_TYPE=${{ matrix.build_type == 'release' && 'RELEASE' || 'DEBUG' }}
          
      - name: Build Layer 2 (Conservation)
        run: |
          cd layers/layer2-conservation
          make BUILD_TYPE=${{ matrix.build_type == 'release' && 'RELEASE' || 'DEBUG' }}
          
      - name: Build Layer 3 (Resonance)
        run: |
          cd layers/layer3-resonance
          make BUILD_TYPE=${{ matrix.build_type == 'release' && 'RELEASE' || 'DEBUG' }}
          
      - name: Upload dependencies
        uses: actions/upload-artifact@v3
        with:
          name: dependencies-${{ matrix.build_type }}
          path: |
            lib/
            include/atlas/
          retention-days: 1

  # Performance benchmarks for x86_64
  benchmark-x86_64:
    needs: [detect-changes, build-dependencies]
    if: needs.detect-changes.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download dependencies
        uses: actions/download-artifact@v3
        with:
          name: dependencies-release
          
      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
          components: clippy, rustfmt
          
      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            layers/layer4-manifold/rs/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('layers/layer4-manifold/rs/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
            
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
          
      - name: Build Layer 4 with benchmarks
        run: |
          cd layers/layer4-manifold/rs
          cargo build --release --features benchmarks
          
      - name: Run performance regression test
        id: regression-test
        run: |
          cd layers/layer4-manifold/benchmarks/ci
          ./regression_test.sh \
            --hardware-profile x86_64 \
            --threshold ${{ github.event.inputs.threshold || '10' }} \
            --output-file benchmark-results-x86_64.json \
            --verbose \
            ${{ github.event.inputs.update_baseline == 'true' && '--update-baseline' || '' }}
        continue-on-error: true
        
      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results-x86_64
          path: layers/layer4-manifold/benchmarks/ci/benchmark-results-x86_64.json
          retention-days: 30
          
      - name: Parse benchmark results for comment
        id: parse-results
        if: always()
        run: |
          cd layers/layer4-manifold/benchmarks/ci
          if [[ -f benchmark-results-x86_64.json ]]; then
            echo "results_found=true" >> $GITHUB_OUTPUT
            # Extract key metrics for comment
            linear_ops=$(jq -r '.operations.linear_projection.ops_per_sec // "N/A"' benchmark-results-x86_64.json)
            r96_ops=$(jq -r '.operations.r96_fourier.ops_per_sec // "N/A"' benchmark-results-x86_64.json)
            shard_ops=$(jq -r '.operations.shard_extraction.ops_per_sec // "N/A"' benchmark-results-x86_64.json)
            transform_ops=$(jq -r '.operations.transformation.ops_per_sec // "N/A"' benchmark-results-x86_64.json)
            
            echo "linear_ops=$linear_ops" >> $GITHUB_OUTPUT
            echo "r96_ops=$r96_ops" >> $GITHUB_OUTPUT
            echo "shard_ops=$shard_ops" >> $GITHUB_OUTPUT
            echo "transform_ops=$transform_ops" >> $GITHUB_OUTPUT
          else
            echo "results_found=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Check regression test result
        if: steps.regression-test.outcome == 'failure'
        run: |
          echo "Performance regression detected!"
          exit 1

  # Performance benchmarks for ARM64 (using QEMU emulation)
  benchmark-arm64:
    needs: [detect-changes, build-dependencies]
    if: needs.detect-changes.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Download dependencies
        uses: actions/download-artifact@v3
        with:
          name: dependencies-release
          
      - name: Setup ARM64 emulation
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          
      - name: Setup Rust for ARM64
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: aarch64-unknown-linux-gnu
          profile: minimal
          override: false
          
      - name: Install cross-compilation tools
        run: |
          sudo apt-get install -y gcc-aarch64-linux-gnu
          
      - name: Cache ARM64 Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            layers/layer4-manifold/rs/target/aarch64-unknown-linux-gnu
          key: ${{ runner.os }}-cargo-arm64-${{ hashFiles('layers/layer4-manifold/rs/Cargo.lock') }}
          
      - name: Build Layer 4 for ARM64
        run: |
          cd layers/layer4-manifold/rs
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          cargo build --release --target aarch64-unknown-linux-gnu --features benchmarks
          
      - name: Run ARM64 benchmarks (emulated)
        id: regression-test-arm64
        run: |
          cd layers/layer4-manifold/benchmarks/ci
          # Note: ARM64 benchmarks under emulation will be slower and less reliable
          # This is primarily for compatibility testing
          timeout 300s ./regression_test.sh \
            --hardware-profile arm64 \
            --threshold 25 \
            --output-file benchmark-results-arm64.json \
            --verbose || echo "ARM64 benchmark timeout or failure (expected under emulation)"
        continue-on-error: true
        
      - name: Upload ARM64 results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results-arm64
          path: layers/layer4-manifold/benchmarks/ci/benchmark-results-arm64.json
          retention-days: 30

  # WASM benchmarks
  benchmark-wasm:
    needs: [detect-changes, build-dependencies]
    if: needs.detect-changes.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Rust with WASM target
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
          profile: minimal
          override: false
          
      - name: Install wasmtime
        run: |
          curl https://wasmtime.dev/install.sh -sSf | bash
          echo "$HOME/.wasmtime/bin" >> $GITHUB_PATH
          
      - name: Cache WASM Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            layers/layer4-manifold/rs/target/wasm32-unknown-unknown
          key: ${{ runner.os }}-cargo-wasm-${{ hashFiles('layers/layer4-manifold/rs/Cargo.lock') }}
          
      - name: Build Layer 4 for WASM
        run: |
          cd layers/layer4-manifold/rs
          cargo build --release --target wasm32-unknown-unknown --no-default-features
          
      - name: Run WASM benchmarks
        id: regression-test-wasm
        run: |
          cd layers/layer4-manifold/benchmarks/ci
          # WASM benchmarks are limited and may not have full feature parity
          timeout 180s ./regression_test.sh \
            --hardware-profile wasm32 \
            --threshold 30 \
            --output-file benchmark-results-wasm32.json \
            --verbose || echo "WASM benchmark completed with limitations"
        continue-on-error: true
        
      - name: Upload WASM results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results-wasm32
          path: layers/layer4-manifold/benchmarks/ci/benchmark-results-wasm32.json
          retention-days: 30

  # Post benchmark results as PR comment
  post-results:
    needs: [benchmark-x86_64, benchmark-arm64, benchmark-wasm]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Download x86_64 results
        uses: actions/download-artifact@v3
        with:
          name: benchmark-results-x86_64
          path: ./results/
        continue-on-error: true
        
      - name: Download ARM64 results
        uses: actions/download-artifact@v3
        with:
          name: benchmark-results-arm64
          path: ./results/
        continue-on-error: true
        
      - name: Download WASM results
        uses: actions/download-artifact@v3
        with:
          name: benchmark-results-wasm32
          path: ./results/
        continue-on-error: true
        
      - name: Generate performance report
        id: generate-report
        run: |
          echo "## ðŸš€ Layer 4 Manifold Performance Report" > report.md
          echo "" >> report.md
          echo "Performance benchmarks for Layer 4 (Manifold) operations:" >> report.md
          echo "" >> report.md
          
          # x86_64 Results
          if [[ -f ./results/benchmark-results-x86_64.json ]]; then
            echo "### ðŸ–¥ï¸ x86_64 Performance" >> report.md
            echo "" >> report.md
            echo "| Operation | Ops/Second | Avg Duration | Throughput |" >> report.md
            echo "|-----------|------------|--------------|------------|" >> report.md
            
            # Parse results with jq
            for op in linear_projection r96_fourier shard_extraction transformation; do
              ops_sec=$(jq -r ".operations.$op.ops_per_sec // \"N/A\"" ./results/benchmark-results-x86_64.json 2>/dev/null || echo "N/A")
              avg_dur=$(jq -r ".operations.$op.avg_duration_ns // 0" ./results/benchmark-results-x86_64.json 2>/dev/null || echo "0")
              throughput=$(jq -r ".operations.$op.throughput_bps // 0" ./results/benchmark-results-x86_64.json 2>/dev/null || echo "0")
              
              # Format duration
              if [[ "$avg_dur" != "N/A" && "$avg_dur" -gt 0 ]]; then
                if [[ "$avg_dur" -gt 1000000 ]]; then
                  avg_dur_fmt="$(echo "scale=2; $avg_dur / 1000000" | bc)ms"
                else
                  avg_dur_fmt="${avg_dur}ns"
                fi
              else
                avg_dur_fmt="N/A"
              fi
              
              # Format throughput
              if [[ "$throughput" != "N/A" && "$throughput" -gt 0 ]]; then
                if [[ "$throughput" -gt 1048576 ]]; then
                  throughput_fmt="$(echo "scale=2; $throughput / 1048576" | bc)MB/s"
                elif [[ "$throughput" -gt 1024 ]]; then
                  throughput_fmt="$(echo "scale=2; $throughput / 1024" | bc)KB/s"
                else
                  throughput_fmt="${throughput}B/s"
                fi
              else
                throughput_fmt="N/A"
              fi
              
              echo "| $(echo $op | tr '_' ' ' | sed 's/.*/\u&/') | $ops_sec | $avg_dur_fmt | $throughput_fmt |" >> report.md
            done
            echo "" >> report.md
          else
            echo "### âŒ x86_64 Performance" >> report.md
            echo "Benchmark failed or results not available." >> report.md
            echo "" >> report.md
          fi
          
          # ARM64 Results
          if [[ -f ./results/benchmark-results-arm64.json ]]; then
            echo "### ðŸ”§ ARM64 Performance (Emulated)" >> report.md
            echo "_Note: Results from emulated environment, not representative of native ARM64 performance._" >> report.md
            echo "" >> report.md
          else
            echo "### âš ï¸ ARM64 Performance" >> report.md
            echo "ARM64 benchmarks not available (emulation timeout or failure)." >> report.md
            echo "" >> report.md
          fi
          
          # WASM Results
          if [[ -f ./results/benchmark-results-wasm32.json ]]; then
            echo "### ðŸŒ WebAssembly Performance" >> report.md
            echo "_Note: WASM benchmarks have limited feature set and may not be directly comparable._" >> report.md
            echo "" >> report.md
          else
            echo "### âš ï¸ WebAssembly Performance" >> report.md
            echo "WASM benchmarks not available or incomplete." >> report.md
            echo "" >> report.md
          fi
          
          echo "---" >> report.md
          echo "_Generated by Layer 4 Performance CI â€¢ $(date -u '+%Y-%m-%d %H:%M:%S UTC')_" >> report.md
          
          # Set output for comment
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const report = `${{ steps.generate-report.outputs.report }}`;
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.data.find(comment => 
              comment.body.includes('Layer 4 Manifold Performance Report')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: report
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

  # Update baseline on main branch if requested
  update-baseline:
    needs: [benchmark-x86_64]
    if: github.ref == 'refs/heads/main' && (github.event.inputs.update_baseline == 'true' || github.event_name == 'push')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download benchmark results
        uses: actions/download-artifact@v3
        with:
          name: benchmark-results-x86_64
          path: ./results/
          
      - name: Update baseline
        run: |
          cd layers/layer4-manifold/benchmarks/ci
          if [[ -f ../../../results/benchmark-results-x86_64.json ]]; then
            # Update baseline with new results
            ./regression_test.sh \
              --hardware-profile x86_64 \
              --threshold 10 \
              --update-baseline \
              --baseline-file performance_baselines.json
          fi
          
      - name: Commit updated baseline
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet layers/layer4-manifold/benchmarks/ci/performance_baselines.json; then
            echo "No baseline updates needed"
          else
            git add layers/layer4-manifold/benchmarks/ci/performance_baselines.json
            git commit -m "chore: Update Layer 4 performance baselines

            ðŸ¤– Automatically updated performance baselines based on main branch benchmarks
            
            - Updated x86_64 profile with improved performance metrics
            - Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            
            git push
          fi