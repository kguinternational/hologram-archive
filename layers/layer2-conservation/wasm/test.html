<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Layer 2 Conservation - WASM Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #34495e;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status.success {
            background-color: #d1edff;
            color: #0c5460;
            border: 1px solid #b8daff;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .log {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .exports-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .export-item {
            background-color: #ecf0f1;
            padding: 8px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .info-box {
            background-color: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .info-box h4 {
            margin-top: 0;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Atlas Layer 2 Conservation - WebAssembly Test</h1>
        
        <div class="info-box">
            <h4>About this test</h4>
            <p>This page tests the Atlas Layer 2 Conservation system compiled to WebAssembly. 
            The Layer 2 implements conservation laws, domain management, and witness operations 
            with single-threaded WASM compatibility using the <code>ATLAS_SINGLE_THREAD</code> macro.</p>
        </div>

        <div class="test-section">
            <h3>1. WASM Module Loading</h3>
            <div id="load-status" class="status loading">Loading WASM module...</div>
            <button id="reload-btn" onclick="loadWasmModule()" disabled>Reload Module</button>
        </div>

        <div class="test-section">
            <h3>2. Module Information</h3>
            <div id="module-info" class="status">Module not loaded</div>
            <div id="exports-container"></div>
        </div>

        <div class="test-section">
            <h3>3. Basic Function Tests</h3>
            <button id="test-basic-btn" onclick="runBasicTests()" disabled>Run Basic Tests</button>
            <div id="basic-test-results"></div>
        </div>

        <div class="test-section">
            <h3>4. Conservation Tests</h3>
            <button id="test-conservation-btn" onclick="runConservationTests()" disabled>Run Conservation Tests</button>
            <div id="conservation-test-results"></div>
        </div>

        <div class="test-section">
            <h3>5. Test Log</h3>
            <button onclick="clearLog()">Clear Log</button>
            <div id="test-log" class="log">Initializing test harness...\n</div>
        </div>
    </div>

    <script>
        let atlasModule = null;
        
        function log(message) {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('test-log').textContent = '';
            log('Log cleared');
        }
        
        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
        }
        
        async function loadWasmModule() {
            try {
                log('Starting WASM module load...');
                updateStatus('load-status', 'loading', 'Loading WASM module...');
                
                // Try to load from build directory first, then current directory
                const wasmPaths = [
                    '../build/wasm/layer2-conservation.wasm',
                    'layer2-conservation.wasm'
                ];
                
                let wasmModule = null;
                let loadedPath = null;
                
                for (const wasmPath of wasmPaths) {
                    try {
                        log(`Attempting to load from: ${wasmPath}`);
                        wasmModule = await WebAssembly.instantiateStreaming(
                            fetch(wasmPath),
                            {
                                env: {
                                    memory: new WebAssembly.Memory({ initial: 256 }),
                                    memcpy: (dest, src, n) => {
                                        const memory = new Uint8Array(atlasModule.memory.buffer);
                                        memory.copyWithin(dest, src, src + n);
                                        return dest;
                                    },
                                    memset: (ptr, value, size) => {
                                        const memory = new Uint8Array(atlasModule.memory.buffer);
                                        memory.fill(value, ptr, ptr + size);
                                        return ptr;
                                    },
                                    malloc: (size) => {
                                        // Simple bump allocator
                                        if (!window.wasmHeapPtr) window.wasmHeapPtr = 1024 * 1024;
                                        const ptr = window.wasmHeapPtr;
                                        window.wasmHeapPtr += size;
                                        log(`malloc(${size}) = 0x${ptr.toString(16)}`);
                                        return ptr;
                                    },
                                    free: (ptr) => {
                                        log(`free(0x${ptr.toString(16)})`);
                                        // No-op for simple allocator
                                    },
                                    // Add some basic libc functions that might be imported
                                    abort: () => {
                                        log('WASM module called abort()');
                                        throw new Error('WASM module aborted');
                                    },
                                    __assert_fail: (condition, file, line, func) => {
                                        log(`Assertion failed: ${condition} at ${file}:${line} in ${func}`);
                                        throw new Error('Assertion failed');
                                    }
                                }
                            }
                        );
                        loadedPath = wasmPath;
                        break;
                    } catch (pathError) {
                        log(`Failed to load from ${wasmPath}: ${pathError.message}`);
                        continue;
                    }
                }
                
                if (!wasmModule) {
                    throw new Error('Could not load WASM module from any path');
                }
                
                atlasModule = wasmModule.instance;
                atlasModule.memory = atlasModule.exports.memory || wasmModule.instance.imports?.env?.memory;
                
                log(`WASM module loaded successfully from: ${loadedPath}`);
                updateStatus('load-status', 'success', `Module loaded successfully from ${loadedPath}`);
                
                // Update module info
                displayModuleInfo();
                
                // Enable test buttons
                document.getElementById('reload-btn').disabled = false;
                document.getElementById('test-basic-btn').disabled = false;
                document.getElementById('test-conservation-btn').disabled = false;
                
                return true;
                
            } catch (error) {
                log(`Error loading WASM module: ${error.message}`);
                updateStatus('load-status', 'error', `Failed to load module: ${error.message}`);
                return false;
            }
        }
        
        function displayModuleInfo() {
            if (!atlasModule) {
                updateStatus('module-info', 'error', 'Module not loaded');
                return;
            }
            
            const exports = Object.keys(atlasModule.exports);
            const memorySize = atlasModule.memory ? 
                `${(atlasModule.memory.buffer.byteLength / (1024 * 1024)).toFixed(1)} MB` : 
                'No memory export';
            
            updateStatus('module-info', 'success', 
                `Module loaded - ${exports.length} exports, Memory: ${memorySize}`);
            
            // Display exports
            const exportsContainer = document.getElementById('exports-container');
            if (exports.length > 0) {
                exportsContainer.innerHTML = `
                    <h4>Exported Functions (${exports.length}):</h4>
                    <div class="exports-list">
                        ${exports.map(name => `<div class="export-item">${name}</div>`).join('')}
                    </div>
                `;
            } else {
                exportsContainer.innerHTML = '<p>No exports found</p>';
            }
            
            log(`Module info: ${exports.length} exports, memory: ${memorySize}`);
            log(`Exports: ${exports.join(', ')}`);
        }
        
        function runBasicTests() {
            if (!atlasModule) {
                log('ERROR: Module not loaded');
                return;
            }
            
            log('=== Running Basic Tests ===');
            const results = [];
            
            try {
                // Test 1: Check if module has expected memory
                if (atlasModule.memory) {
                    results.push('✓ Memory export found');
                    log(`Memory size: ${atlasModule.memory.buffer.byteLength} bytes`);
                } else {
                    results.push('⚠ No memory export found');
                }
                
                // Test 2: Check for Atlas conservation functions
                const expectedFunctions = [
                    'atlas_create_domain',
                    'atlas_destroy_domain',
                    'atlas_allocate_witness',
                    'atlas_free_witness'
                ];
                
                expectedFunctions.forEach(funcName => {
                    if (atlasModule.exports[funcName]) {
                        results.push(`✓ Function ${funcName} found`);
                        log(`Found function: ${funcName}`);
                    } else {
                        results.push(`⚠ Function ${funcName} not found`);
                        log(`Missing function: ${funcName}`);
                    }
                });
                
                // Test 3: Try to call a simple function if available
                if (atlasModule.exports.atlas_get_version) {
                    try {
                        const version = atlasModule.exports.atlas_get_version();
                        results.push(`✓ atlas_get_version() returned: ${version}`);
                        log(`Version: ${version}`);
                    } catch (error) {
                        results.push(`⚠ atlas_get_version() failed: ${error.message}`);
                        log(`Version call failed: ${error.message}`);
                    }
                }
                
                log('=== Basic Tests Completed ===');
                
            } catch (error) {
                results.push(`✗ Basic tests failed: ${error.message}`);
                log(`Basic test error: ${error.message}`);
            }
            
            document.getElementById('basic-test-results').innerHTML = 
                `<div class="status ${results.some(r => r.includes('✗')) ? 'error' : 'success'}">
                    ${results.join('<br>')}
                </div>`;
        }
        
        function runConservationTests() {
            if (!atlasModule) {
                log('ERROR: Module not loaded');
                return;
            }
            
            log('=== Running Conservation Tests ===');
            const results = [];
            
            try {
                // Test domain creation if the function is available
                if (atlasModule.exports.atlas_create_domain) {
                    try {
                        log('Testing domain creation...');
                        // Note: This might fail without proper setup, but we can test the call
                        const domainId = atlasModule.exports.atlas_create_domain(0);
                        results.push(`✓ atlas_create_domain(0) returned: ${domainId}`);
                        log(`Domain created with ID: ${domainId}`);
                        
                        // Try to destroy it
                        if (atlasModule.exports.atlas_destroy_domain && domainId >= 0) {
                            const destroyResult = atlasModule.exports.atlas_destroy_domain(domainId);
                            results.push(`✓ atlas_destroy_domain(${domainId}) returned: ${destroyResult}`);
                            log(`Domain ${domainId} destruction result: ${destroyResult}`);
                        }
                    } catch (error) {
                        results.push(`⚠ Domain operations failed: ${error.message}`);
                        log(`Domain test error: ${error.message}`);
                    }
                } else {
                    results.push('⚠ Domain functions not available');
                }
                
                // Test witness operations if available
                if (atlasModule.exports.atlas_allocate_witness) {
                    try {
                        log('Testing witness allocation...');
                        const witnessPtr = atlasModule.exports.atlas_allocate_witness(0, 1024);
                        results.push(`✓ atlas_allocate_witness(0, 1024) returned: 0x${witnessPtr.toString(16)}`);
                        log(`Witness allocated at: 0x${witnessPtr.toString(16)}`);
                        
                        if (atlasModule.exports.atlas_free_witness && witnessPtr !== 0) {
                            const freeResult = atlasModule.exports.atlas_free_witness(witnessPtr);
                            results.push(`✓ atlas_free_witness(0x${witnessPtr.toString(16)}) returned: ${freeResult}`);
                            log(`Witness free result: ${freeResult}`);
                        }
                    } catch (error) {
                        results.push(`⚠ Witness operations failed: ${error.message}`);
                        log(`Witness test error: ${error.message}`);
                    }
                } else {
                    results.push('⚠ Witness functions not available');
                }
                
                log('=== Conservation Tests Completed ===');
                
            } catch (error) {
                results.push(`✗ Conservation tests failed: ${error.message}`);
                log(`Conservation test error: ${error.message}`);
            }
            
            document.getElementById('conservation-test-results').innerHTML = 
                `<div class="status ${results.some(r => r.includes('✗')) ? 'error' : 'success'}">
                    ${results.join('<br>')}
                </div>`;
        }
        
        // Initialize the test page
        document.addEventListener('DOMContentLoaded', function() {
            log('Test harness initialized');
            log('Attempting to auto-load WASM module...');
            loadWasmModule();
        });
    </script>
</body>
</html>